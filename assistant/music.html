<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Party Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-color: #00BFFF; --brand-color-glow: rgba(0, 191, 255, 0.4);
            --bg-color-start: #1D2B64; --bg-color-mid: #0f172a; --bg-color-end: #000000;
            --text-color: #ffffff; --text-color-muted: rgba(255, 255, 255, 0.6);
            --card-bg: rgba(22, 22, 37, 0.7); --card-border: rgba(255, 255, 255, 0.15);
        }
        html { -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-color-start), var(--bg-color-mid), var(--bg-color-end)); background-attachment: fixed; color: var(--text-color); min-height: 100vh; margin: 0; overflow: hidden; }
        
        .screen { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; width: 100%; padding: 1.5rem; position: absolute; inset: 0; opacity: 0; visibility: hidden; transition: opacity 0.6s ease; }
        .screen.active { opacity: 1; visibility: visible; }

        .welcome-card { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 1.5rem; border: 1px solid var(--card-border); box-shadow: 0 8px 32px rgba(0,0,0,0.3); padding: 2rem; width: 100%; max-width: 480px; }
        .btn-brand { background-color: var(--brand-color); border: none; font-weight: 600; border-radius: 2rem; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--brand-color-glow); }
        .btn-brand:hover { background-color: #1E90FF; transform: translateY(-2px); box-shadow: 0 6px 20px var(--brand-color-glow); }

        #player-screen { justify-content: normal; padding: 0; }
        .player-layout { width: 100%; height: 100vh; display: grid; grid-template-rows: auto 1fr auto; }
        #player-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
        .player-main-content { overflow-y: auto; padding: 1.5rem; }
        .player-footer { background: rgba(0,0,0,0.4); backdrop-filter: blur(15px); border-top: 1px solid var(--card-border); }
        
        #player-header .user-info { display: flex; align-items: center; gap: 0.75rem; background: var(--card-bg); padding: 0.5rem 1rem; border-radius: 2rem; border: 1px solid var(--card-border); }
        .action-buttons { display: flex; align-items: center; gap: 0.75rem; }
        .action-buttons .btn { color: var(--text-color); background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .action-buttons .btn:hover { background: var(--brand-color); border-color: var(--brand-color); }

        .now-playing-bar { display: grid; grid-template-columns: 1fr 2fr 1fr; align-items: center; gap: 1rem; padding: 1rem 1.5rem; }
        .song-info { display: flex; align-items: center; gap: 1rem; }
        #footer-album-art { width: 60px; height: 60px; background-color: rgba(255,255,255,0.1); border-radius: 8px; background-size: cover; background-position: center; }
        #footer-song-title { font-weight: 700; }
        #footer-song-artist { color: var(--text-color-muted); font-size: 0.9rem; }
        .player-controls-footer { display: flex; flex-direction: column; align-items: center; }
        .footer-buttons { display: flex; align-items: center; gap: 1rem; }
        .footer-buttons .btn { background: transparent; border: none; color: var(--text-color); font-size: 1.5rem; }
        .footer-buttons #playPauseBtn { font-size: 2.5rem; }
        .is-guest .host-only { display: none !important; }

        #seekBar { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: linear-gradient(to right, var(--brand-color) var(--seek-progress, 0%), rgba(255,255,255,0.2) var(--seek-progress, 0%)); border-radius: 3px; outline: none; }
        #seekBar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--text-color); border-radius: 50%; cursor: pointer; }
        .is-guest #seekBar { pointer-events: none; }

        #library-list .list-group-item { background: transparent; border-color: var(--card-border); color: var(--text-color); transition: background-color 0.2s; border-left: 3px solid transparent; }
        #library-list .list-group-item:hover { background-color: rgba(255,255,255,0.05); }
        body.is-playing #library-list .list-group-item.active { background-color: rgba(0, 191, 255, 0.1); border-left-color: var(--brand-color); }
        
        #connection-overlay { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); background: rgba(0,0,0,0.7); z-index: 1000; }
        .loader span { width: 12px; height: 12px; background: var(--brand-color); border-radius: 50%; animation: bounce 1.2s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        .modal-content { background: #181818; border-radius: 1rem; color: var(--text-color); border: 1px solid var(--card-border); }
        #qr-code-canvas { border: 5px solid white; border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div id="welcome-screen" class="screen active">
        <div class="welcome-card"><div class="card-body text-center"><i class="bi bi-music-note-beamed" style="font-size: 3.5rem; color: var(--brand-color);"></i><h2 class="mt-3 fw-bold">Music Party Cloud</h2><p class="text-white-50">Sync your music, vibe together, anywhere.</p><div class="d-grid gap-3 my-4"><button id="hostBtn" class="btn btn-brand btn-lg"><i class="bi bi-broadcast-pin me-2"></i> Host Party</button></div><hr style="border-color: var(--card-border);"><h5 class="mb-3 fw-semibold">Join a Party</h5><div class="input-group"><button id="scanQrBtn" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#qrScannerModal"><i class="bi bi-qr-code-scan"></i></button><input id="partyIdInput" class="form-control" placeholder="Enter Party ID"><button id="joinBtn" class="btn btn-brand"><i class="bi bi-arrow-right-circle-fill"></i></button></div></div></div>
    </div>

    <div id="player-screen" class="screen">
        <div id="connection-overlay" class="d-none"><div class="loader d-flex gap-2"><span></span><span></span><span></span></div><p id="connection-status" class="mt-3 fs-5">Initializing...</p></div>

        <div class="player-layout">
            <header id="player-header">
                <div class="user-info"><div id="user-display-name" class="user-name"></div></div>
                <div class="action-buttons"><button class="btn" data-bs-toggle="modal" data-bs-target="#infoModal" aria-label="Party Info"><i class="bi bi-info-circle"></i></button><button id="manageLibraryBtn" class="btn host-only" data-bs-toggle="modal" data-bs-target="#libraryModal"><i class="bi bi-plus-lg"></i></button><button id="leaveBtn" class="btn btn-danger" aria-label="Leave party"><i class="bi bi-box-arrow-left"></i></button></div>
            </header>
            <main class="player-main-content">
                <h3 class="mb-3 d-flex justify-content-between align-items-center">
                    <span>Playlist (<span id="guest-count">0</span> Guests)</span>
                    <div id="ping-display" class="d-none"><i class="bi bi-reception-4 me-2"></i><span id="ping-value">-</span> ms</div>
                </h3>
                <ul id="library-list" class="list-group list-group-flush"></ul>
            </main>
            <footer class="player-footer">
                <div class="now-playing-bar">
                    <div class="song-info"><div id="footer-album-art"></div><div><div id="footer-song-title" class="fw-bold">No song playing</div><div id="footer-song-artist" class="small"></div></div></div>
                    <div class="player-controls-footer">
                        <div class="footer-buttons host-only"><button id="prevBtn" class="btn"><i class="bi bi-skip-start-fill"></i></button><button id="playPauseBtn" class="btn"><i class="bi bi-play-circle-fill"></i></button><button id="nextBtn" class="btn"><i class="bi bi-skip-end-fill"></i></button></div>
                        <div class="progress-container w-100 mt-2"><input type="range" id="seekBar" value="0"><div class="d-flex justify-content-between font-monospace small text-white-50 mt-1"><span id="current-time">0:00</span><span id="duration">0:00</span></div></div>
                    </div>
                    <div class="d-flex justify-content-end align-items-center"><button id="fullscreenBtn" class="btn action-buttons" aria-label="Toggle fullscreen"><i class="bi bi-fullscreen"></i></button></div>
                </div>
            </footer>
        </div>
        <audio id="audioPlayer" crossorigin="anonymous"></audio>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Party Info</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><div class="host-only mb-3"><p>Guests can scan this QR code to join!</p><canvas id="qr-code-canvas"></canvas></div><p class="text-white-50">Or share this Party ID:</p><div class="input-group"><input type="text" id="party-id-text" class="form-control" readonly><button class="btn btn-brand" id="copy-id-btn"><i class="bi bi-clipboard"></i></button></div><hr><div class="text-start"><strong>Host:</strong> <span id="modal-host-name"></span><br><strong>Guests (<span id="modal-guest-count">0</span>):</strong><ul id="modal-guest-list" class="list-unstyled ps-3"></ul></div></div></div></div></div>
    <div class="modal fade" id="libraryModal" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-music-note-list me-2"></i>My Music Library</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-tabs nav-fill" role="tablist"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#my-songs-pane" type="button"><i class="bi bi-collection-play-fill me-2"></i>My Songs</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#add-new-pane" type="button"><i class="bi bi-cloud-arrow-up-fill me-2"></i>Add New</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="my-songs-pane" role="tabpanel"><ul id="library-list" class="list-group list-group-flush mt-3"></ul></div><div class="tab-pane fade" id="add-new-pane" role="tabpanel"><div class="p-3"><div id="upload-progress-container" class="progress mb-3 d-none"><div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width:0%"></div></div><div class="d-grid gap-3"><p class="text-white-50 text-center small">Upload MP3 files or add a direct URL.</p><label for="songFileInput" id="uploadBtnLabel" class="btn btn-brand"><i class="bi bi-upload me-2"></i>Upload MP3 File</label><input type="file" id="songFileInput" accept="audio/mpeg" class="d-none"><div class="input-group"><input type="url" id="customSongUrlInput" class="form-control" placeholder="Enter custom MP3 URL"><button id="addCustomUrlBtn" class="btn btn-outline-success"><i class="bi bi-plus-circle-fill"></i></button></div></div></div></div></div></div></div></div></div>
    <div class="modal fade" id="qrScannerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content bg-dark text-white rounded-3"><div class="modal-header border-0"><h5 class="modal-title fw-bold"><i class="bi bi-qr-code-scan me-2"></i>Scan QR Code</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><video id="qr-video" style="width:100%; height:300px;"></video><p class="mt-3">Point your camera at the QR code.</p></div></div></div></div>

    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- DOM & STATE ---
    const welcomeScreen = document.getElementById("welcome-screen"), playerScreen = document.getElementById("player-screen"),
    audio = document.getElementById("audioPlayer"), 
    footerAlbumArt = document.getElementById('footer-album-art'), footerSongTitle = document.getElementById('footer-song-title'),
    footerSongArtist = document.getElementById('footer-song-artist'),
    playPauseBtn = document.getElementById("playPauseBtn"), prevBtn = document.getElementById("prevBtn"), 
    nextBtn = document.getElementById("nextBtn"), connectionOverlay = document.getElementById('connection-overlay'), 
    connectionStatus = document.getElementById('connection-status'), logPopupContent = document.getElementById('log-popup-content'), 
    seekBar = document.getElementById('seekBar'), currentTimeEl = document.getElementById('current-time'), 
    durationEl = document.getElementById('duration'), libraryListEl = document.getElementById('library-list'), 
    userDisplayNameEl = document.getElementById('user-display-name'), guestCountEl = document.getElementById('guest-count'), 
    partyIdText = document.getElementById('party-id-text'), qrCodeCanvas = document.getElementById('qr-code-canvas'), 
    copyIdBtn = document.getElementById('copy-id-btn'), modalHostNameEl = document.getElementById('modal-host-name'), 
    modalGuestCountEl = document.getElementById('modal-guest-count'), modalGuestListEl = document.getElementById('modal-guest-list'),
    hostBtn = document.getElementById('hostBtn'), joinBtn = document.getElementById('joinBtn'), 
    partyIdInput = document.getElementById('partyIdInput'), leaveBtn = document.getElementById('leaveBtn'), 
    fullscreenBtn = document.getElementById('fullscreenBtn'), addCustomUrlBtn = document.getElementById('addCustomUrlBtn'),
    customSongUrlInput = document.getElementById('customSongUrlInput'), songFileInput = document.getElementById('songFileInput'),
    uploadProgressContainer = document.getElementById('upload-progress-container'),
    uploadProgressBar = document.getElementById('upload-progress-bar'), infoModal = document.getElementById('infoModal'),
    pingDisplay = document.getElementById('ping-display'), pingValue = document.getElementById('ping-value'),
    scanQrBtn = document.getElementById('scanQrBtn'), qrModalEl = document.getElementById('qrScannerModal'),
    qrVideo = document.getElementById('qr-video');
    let isHost = false, partyRef, libraryRef, currentTrackIndex = 0, syncInterval;
    let deviceId, currentUser, userData = { displayName: 'Guest' }, scanner;
    let playlistItems = [], lastKnownState = null, userInteracted = false;
    const SESSION_KEY = 'musicPartySession';

    let peerConnections = {}; 
    let dataChannels = {};
    let guestPings = {}; 

    const iceConfiguration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    const firebaseConfig = { apiKey: "AIzaSyCpOy4pqmtIsvJMtgoCzbQkLYTwR61cExk", authDomain: "probody-deec4.firebaseapp.com", databaseURL: "https://probody-deec4-default-rtdb.firebaseio.com", projectId: "probody-deec4", storageBucket: "probody-deec4.appspot.com", messagingSenderId: "704731000262", appId: "1:704731000262:web:4b3f4c4b8a0c4e71a8d6c7" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.database(), storage = firebase.storage();

    // --- Initialization & Core Listeners ---
    window.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user; deviceId = user.uid;
                listenToUserData(deviceId);
                startAppFromState();
            } else { window.location.href = '../login.html'; }
        });
        copyIdBtn.addEventListener('click', () => { navigator.clipboard.writeText(partyIdText.value).then(() => logToUI('Party ID copied!', 'success')); });
        infoModal.addEventListener('show.bs.modal', () => {
            if(isHost) {
                const partyId = deviceId;
                const joinUrl = `${window.location.origin}${window.location.pathname}?party=${partyId}`;
                QRCode.toCanvas(qrCodeCanvas, joinUrl, { width: 200, color: { dark:"#FFFFFF", light:"#00000000" } }, e => e && console.error(e));
            }
        });
        scanQrBtn.addEventListener('click', () => {
            const qrModal = new bootstrap.Modal(qrModalEl);
            qrModal.show();
        });
        qrModalEl.addEventListener('shown.bs.modal', () => {
            scanner = new Instascan.Scanner({ video: qrVideo, mirror: false });
            scanner.addListener('scan', content => {
                try {
                    const url = new URL(content);
                    const partyId = url.searchParams.get('party');
                    if(partyId) {
                        partyIdInput.value = partyId;
                        bootstrap.Modal.getInstance(qrModalEl).hide();
                    } else { logToUI('Invalid QR code scanned.', 'error'); }
                } catch (e) {
                     partyIdInput.value = content.trim();
                     bootstrap.Modal.getInstance(qrModalEl).hide();
                }
            });
            Instascan.Camera.getCameras().then(cameras => {
                if (cameras.length > 0) {
                    let backCamera = cameras.find(cam => cam.name.toLowerCase().includes('back')) || cameras[0];
                    scanner.start(backCamera);
                } else { alert('No camera found!'); }
            }).catch(err => console.error(err));
        });
        qrModalEl.addEventListener('hidden.bs.modal', () => {
            if (scanner) { scanner.stop(); }
        });
    });

    function startAppFromState() {
        const urlParams = new URLSearchParams(window.location.search);
        const partyIdFromUrl = urlParams.get('party');
        const session = JSON.parse(localStorage.getItem(SESSION_KEY));
        if (partyIdFromUrl) {
            startGuest(partyIdFromUrl);
        } else if (session?.partyId) {
            isHost = session.isHost;
            isHost ? startHost() : startGuest(session.partyId);
        }
    }

    function listenToUserData(userId) { db.ref(`users/${userId}`).on('value', s => { userData = s.exists() ? s.val() : { displayName: 'Guest' }; if (playerScreen.classList.contains('active')) { userDisplayNameEl.textContent = getProcessedDisplayName(userData.displayName); } }); }
    function getProcessedDisplayName(displayName) { if (!displayName) return 'Guest'; if (displayName.includes(' ')) return displayName.split(' ')[0]; return displayName.substring(0, 5); }

    // --- Party Logic (Multi-Guest Ready) ---
    async function startHost() {
        isHost = true; show("player"); playerScreen.classList.add('is-host');
        const partyId = deviceId;
        localStorage.setItem(SESSION_KEY, JSON.stringify({ partyId, isHost: true }));
        partyIdText.value = partyId; userDisplayNameEl.textContent = getProcessedDisplayName(userData.displayName); modalHostNameEl.textContent = userData.displayName;
        partyRef = db.ref(`parties/${partyId}`); libraryRef = db.ref(`libraries/${deviceId}`);
        await partyRef.set({ hostId: deviceId, hostName: userData.displayName, guests: {} });

        partyRef.child('guests').on('child_added', (guestSnapshot) => {
            const guestId = guestSnapshot.key;
            if (guestSnapshot.val().status === 'requesting' && !peerConnections[guestId]) {
                logToUI(`${guestSnapshot.val().name} is connecting...`, 'info');
                createPeerConnectionForGuest(guestId);
            }
        });
        partyRef.child('guests').on('value', s => updateGuestListUI(s.val()));
        libraryRef.on('value', s => updatePlaylist(s.exists() ? Object.keys(s.val()).map(key => ({ ...s.val()[key], songId: key })) : []));
        syncInterval = setInterval(broadcastState, 2000);
    }

    async function createPeerConnectionForGuest(guestId) {
        peerConnections[guestId] = new RTCPeerConnection(iceConfiguration);
        const pc = peerConnections[guestId];
        pc.onicecandidate = e => e.candidate && partyRef.child(`guests/${guestId}/iceCandidates/host`).push(e.candidate.toJSON());
        
        dataChannels[guestId] = pc.createDataChannel("partySync");
        const dc = dataChannels[guestId];
        dc.onopen = () => { logToUI(`Connection with ${guestId.substring(0,5)} established!`, 'success'); sendFullStateToPeers(guestId); };
        dc.onmessage = (event) => { const data = JSON.parse(event.data); if (data.type === 'pong') { guestPings[guestId] = Date.now() - data.payload; } };
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await partyRef.child(`guests/${guestId}/offer`).set({ sdp: offer.sdp, type: offer.type });

        partyRef.child(`guests/${guestId}/answer`).on('value', async s => {
            if (s.exists() && !pc.currentRemoteDescription) { await pc.setRemoteDescription(new RTCSessionDescription(s.val())); }
        });
        partyRef.child(`guests/${guestId}/iceCandidates/guest`).on('child_added', s => pc.remoteDescription && s.exists() && pc.addIceCandidate(new RTCIceCandidate(s.val())));
    }

    async function startGuest(partyId) {
        isHost = false; show("player"); playerScreen.classList.add('is-guest');
        connectionOverlay.classList.remove('d-none'); connectionStatus.textContent = 'Connecting...';
        partyRef = db.ref(`parties/${partyId}`);
        const s = await partyRef.once('value');
        if (!s.exists()) { alert('Party not found!'); return disconnect(); }
        
        await partyRef.child(`guests/${deviceId}`).set({ name: userData.displayName, status: 'requesting' });

        peerConnection = new RTCPeerConnection(iceConfiguration);
        peerConnection.onicecandidate = e => e.candidate && partyRef.child(`guests/${deviceId}/iceCandidates/guest`).push(e.candidate.toJSON());
        peerConnection.ondatachannel = event => {
            dataChannel = event.channel;
            dataChannel.onmessage = e => handleStateSync(JSON.parse(e.data));
            dataChannel.onopen = () => { logToUI('Connected to host!', 'success'); connectionOverlay.classList.add('d-none'); localStorage.setItem(SESSION_KEY, JSON.stringify({ partyId, isHost: false })); };
            dataChannel.onclose = () => { logToUI('Host disconnected.', 'error'); disconnect(); };
        };

        partyRef.child(`guests/${deviceId}/offer`).on('value', async s => {
            if(s.exists() && !peerConnection.remoteDescription) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(s.val()));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await partyRef.child(`guests/${deviceId}/answer`).set({ sdp: answer.sdp, type: answer.type });
                partyRef.child(`guests/${deviceId}/iceCandidates/host`).on('child_added', s => peerConnection.remoteDescription && s.exists() && peerConnection.addIceCandidate(new RTCIceCandidate(s.val())));
            }
        });
        
        const hostData = s.val(); modalHostNameEl.textContent = hostData.hostName || 'Host';
        partyRef.child('guests').on('value', s => { updateGuestListUI(s.val()); });
        partyIdText.value = partyId; userDisplayNameEl.textContent = getProcessedDisplayName(userData.displayName);
    }

    async function disconnect() {
        clearInterval(syncInterval); pingDisplay.classList.add('d-none');
        localStorage.removeItem(SESSION_KEY);
        Object.values(dataChannels).forEach(dc => dc.close()); Object.values(peerConnections).forEach(pc => pc.close());
        if(!isHost && partyRef) { await partyRef.child(`guests/${deviceId}`).remove(); }
        if (isHost && partyRef) await partyRef.remove();
        partyRef?.off(); libraryRef?.off();
        isHost = false; audio.pause(); audio.src = ''; document.body.classList.remove('is-playing');
        window.history.pushState({}, document.title, window.location.pathname);
        document.exitFullscreen?.();
        show('welcome');
    }

    // --- Playback & Sync Logic ---
    function broadcastState() {
        if (!isHost) return;
        const state = { type: 'state', payload: { trackIndex: currentTrackIndex, time: audio.currentTime, isPaused: audio.paused }};
        const ping = { type: 'ping', payload: Date.now() };
        for (const guestId in dataChannels) {
            if (dataChannels[guestId].readyState === 'open') {
                dataChannels[guestId].send(JSON.stringify(state));
                dataChannels[guestId].send(JSON.stringify(ping));
            }
        }
    }
    function sendFullStateToPeers(guestId) {
        if (!isHost) return;
        const state = { type: 'fullSync', payload: { playlist: playlistItems, trackIndex: currentTrackIndex, time: audio.currentTime, isPaused: audio.paused }};
        if(guestId && dataChannels[guestId]?.readyState === 'open') {
            dataChannels[guestId].send(JSON.stringify(state));
        } else {
            for (const id in dataChannels) {
                if (dataChannels[id].readyState === 'open') {
                    dataChannels[id].send(JSON.stringify(state));
                }
            }
        }
    }
    
    function handleStateSync(data) {
        if(data.type === 'ping') { return dataChannel.send(JSON.stringify({ type: 'pong', payload: data.payload })); }
        const state = data.payload; lastKnownState = state;
        if (data.type === 'fullSync') {
            updatePlaylist(state.playlist);
            if (playlistItems.length > 0 && state.trackIndex < playlistItems.length) playTrack(state.trackIndex, false);
        }
        if (!playlistItems.length || state.trackIndex >= playlistItems.length) return;
        if (currentTrackIndex !== state.trackIndex) playTrack(state.trackIndex, false);
        else if (Math.abs(audio.currentTime - state.time) > 1.0) {
            const newTime = state.time;
            if (isFinite(newTime)) audio.currentTime = newTime;
        }
        if (state.isPaused && !audio.paused) audio.pause();
        else if (!state.isPaused && audio.paused && userInteracted) audio.play();
    }
    function playTrack(index, isHostAction) {
        if (!playlistItems || index >= playlistItems.length || index < 0) return;
        currentTrackIndex = index;
        const track = playlistItems[index];
        if (!track?.url) { if (isHost) nextBtn.click(); return; }
        
        footerSongTitle.textContent = track.title || 'Untitled';
        footerSongArtist.textContent = track.artist || 'Unknown Artist';
        const hasArt = !!track.albumArt;
        footerAlbumArt.style.backgroundImage = hasArt ? `url(${track.albumArt})` : '';
        
        document.querySelectorAll('#library-list .list-group-item').forEach((item, idx) => item.classList.toggle('active', idx === index));

        if (audio.src !== track.url) {
            audio.src = track.url; audio.load();
            const onCanPlay = () => { const shouldPlay = isHostAction || (lastKnownState && !lastKnownState.isPaused); if (shouldPlay && userInteracted) audio.play().catch(e => logToUI('Playback blocked.', 'error')); };
            audio.addEventListener('canplay', onCanPlay, { once: true });
            audio.addEventListener('error', () => { logToUI(`Error loading ${track.title}. Skipping.`, 'error'); if(isHost) nextBtn.click() }, { once: true });
        } else if (isHostAction) { audio.play(); }
    }

    // --- UI, Library & Uploads ---
    function show(screen) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screen + "-screen").classList.add('active'); }
    function updatePlaylist(newPlaylist) {
        const wasEmpty = playlistItems.length === 0;
        playlistItems = newPlaylist || [];
        libraryListEl.innerHTML = playlistItems.length > 0 ? playlistItems.map(item => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><div class="fw-bold">${item.title}</div><small class="text-white-50">${item.artist}</small></div>
                ${isHost ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteSong('${item.songId}', '${item.storagePath || ''}')">&times;</button>` : ''}
            </li>`).join('') : '<li class="list-group-item text-center text-white-50">Your library is empty.</li>';
        if (isHost && wasEmpty && playlistItems.length > 0) playTrack(0, true);
        if (isHost) sendFullStateToPeers();
    }
    function updateGuestListUI(guestList) {
        const count = guestList ? Object.keys(guestList).length : 0;
        guestCountEl.textContent = count; modalGuestCountEl.textContent = count;
        modalGuestListEl.innerHTML = guestList ? Object.keys(guestList).map(guestId => `<li>${guestList[guestId].name} <span class="text-white-50 ms-2">(${guestPings[guestId] || '-'}ms)</span></li>`).join('') : '<li>No guests connected</li>';
        if (count > 0) pingDisplay.classList.remove('d-none');
        else pingDisplay.classList.add('d-none');
    }
    function handleFileUpload(file) { /* ... same as previous version ... */ }
    function handleAddCustomUrl() { /* ... same as previous version ... */ }
    function deleteSong(songId, storagePath) { /* ... same as previous version ... */ }
    function parseSongInfo(filename) { const c = decodeURIComponent(filename.replace(/\.[^/.]+$/, "")); return c.includes(' - ') ? { artist: c.split(' - ')[0].trim(), title: c.split(' - ').slice(1).join(' - ').trim() } : { artist: 'Unknown Artist', title: c }; }
    function formatTime(s) { const m = Math.floor((s||0)/60); return `${m}:${(Math.floor((s||0)%60))<10?'0':''}${Math.floor((s||0)%60)}`; }
    function logToUI(m, t='info') { /* ... same as previous version ... */ }
    
    // --- Event Listeners ---
    hostBtn.onclick = startHost;
    joinBtn.onclick = () => partyIdInput.value.trim() && startGuest(partyIdInput.value.trim());
    leaveBtn.onclick = disconnect;
    fullscreenBtn.onclick = () => document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen();
    playPauseBtn.onclick = () => isHost && (audio.paused ? audio.play() : audio.pause());
    prevBtn.onclick = () => isHost && playTrack((currentTrackIndex - 1 + playlistItems.length) % playlistItems.length, true);
    nextBtn.onclick = () => isHost && playTrack((currentTrackIndex + 1) % playlistItems.length, true);
    addCustomUrlBtn.onclick = handleAddCustomUrl;
    songFileInput.addEventListener('change', e => e.target.files[0] && handleFileUpload(e.target.files[0]));

    const playIcon='<i class="bi bi-play-circle-fill"></i>', pauseIcon='<i class="bi bi-pause-circle-fill"></i>';
    audio.onplay = () => { if (isHost) playPauseBtn.innerHTML = pauseIcon; document.body.classList.add('is-playing'); };
    audio.onpause = () => { if (isHost) playPauseBtn.innerHTML = pauseIcon; document.body.classList.remove('is-playing'); };
    audio.onended = () => { if (isHost) nextBtn.click(); };
    audio.ontimeupdate = ()=> {
        const progress = (audio.currentTime / audio.duration) * 100 || 0;
        seekBar.style.setProperty('--seek-progress', `${progress}%`);
        seekBar.value = progress;
        currentTimeEl.textContent = formatTime(audio.currentTime);
    };
    seekBar.oninput = (e)=> {
        if (!isHost) return;
        const newTime = (e.target.value / 100) * audio.duration;
        if (isFinite(newTime)) {
            audio.currentTime = newTime;
        }
        broadcastState();
    };
    document.body.addEventListener('click', () => { if(!userInteracted) { userInteracted = true; if(lastKnownState && !lastKnownState.isPaused) audio.play().catch(()=>{}); logToUI('Audio context unlocked.', 'success'); } }, { once: true });
</script>
</body>
</html>