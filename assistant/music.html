<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Party Sync</title>
    <!-- Bootstrap 5 Light Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            background-color: #f8f9fa;
            color: #212529;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            padding-bottom: 100px; /* Space for the bottom bar */
        }
        #welcome-screen .card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
        }
        #welcome-screen .btn-action {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
        }
        .player-container {
            width: 100%;
            max-width: 450px;
            background: #ffffff;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #dee2e6;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        #audioVisualizer {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            background-color: #212529;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .song-title {
            font-size: 24px; font-weight: 600; margin: 10px 0 5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .artist { font-size: 16px; color: #6c757d; margin-bottom: 20px; }
        #playlist li.active { background-color: #1DB954; color: #fff; border-color: #1DB954; }
        #playlist li { cursor: pointer; display: flex; align-items: center; }
        .player-controls button:hover {
            color: #1DB954;
            transform: scale(1.1);
        }
        .action-bar {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        #log-popup-content {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        #log-popup-content div {
            padding: 3px 5px;
            border-bottom: 1px solid #dee2e6;
        }
        #log-popup-content div:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- WELCOME SCREEN -->
        <div id="welcome-screen" class="screen">
            <div class="card p-4 p-md-5" style="width: 100%; max-width: 500px;">
                <div class="card-body text-center">
                    <i class="bi bi-music-note-beamed" style="font-size: 4rem; color: #1DB954;"></i>
                    <h2 class="card-title my-3">Welcome to Music Party</h2>
                    <p class="card-text text-muted mb-4">Sync music with friends in real-time.</p>
                    <div class="d-grid gap-3"><button id="hostBtn" class="btn btn-success btn-lg btn-action"><i class="bi bi-person-plus-fill me-2"></i>Host a New Party</button></div>
                    <hr class="my-4">
                    <h5 class="mb-3">Or Join an Existing Party</h5>
                    <div class="input-group">
                        <input type="text" id="roomIdInput" class="form-control" placeholder="Enter Room ID">
                        <button id="joinBtn" class="btn btn-outline-primary"><i class="bi bi-arrow-right-circle-fill"></i> Join</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PLAYER SCREEN -->
        <div id="player-screen" class="screen d-none">
            <div class="player-container">
                <div id="info-bar" class="alert alert-secondary text-center p-2 mb-3"></div>
                <canvas id="audioVisualizer"></canvas>
                <div id="current-song-title" class="song-title">Select a song</div>
                <div class="artist">Music Party</div>
                <audio id="audioPlayer" class="w-100 my-3 d-none" crossOrigin="anonymous"></audio>
                <div class="player-controls d-flex justify-content-center align-items: center gap-4 mb-4">
                    <button id="prevBtn" class="btn btn-lg text-dark"><i class="bi bi-skip-start-fill fs-2"></i></button>
                    <button id="playPauseBtn" class="btn btn-dark rounded-circle" style="width: 65px; height: 65px; font-size: 2.2rem; display: flex; align-items: center; justify-content: center;"><i class="bi bi-play-fill"></i></button>
                    <button id="nextBtn" class="btn btn-lg text-dark"><i class="bi bi-skip-end-fill fs-2"></i></button>
                </div>
                <ul id="playlist" class="list-group list-group-flush text-start">
                    <li class="list-group-item" data-title="Tere Jaisa Yaar Kahan" data-url="./Tere jaisa.mp3">Tere Jaisa Yaar Kahan</li>
                    <li class="list-group-item" data-title="Electronic Rock" data-url="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">SoundHelix Song 2</li>
                    <li class="list-group-item" data-title="Acoustic Blues" data-url="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">SoundHelix Song 3</li>
                    <li class="list-group-item" data-title="Jazz Fusion" data-url="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3">SoundHelix Song 4</li>
                </ul>
            </div>
            <div class="action-bar fixed-bottom bg-light p-3">
                <div class="container d-flex justify-content-between align-items: center" style="max-width: 450px;">
                    <i class="bi bi-volume-up-fill fs-4 text-muted"></i>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#logModal"><i class="bi bi-terminal me-2"></i>Console</button>
                        <button id="leaveBtn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-left me-2"></i>Leave Party</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOG MODAL -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="logModalLabel"><i class="bi bi-terminal me-2"></i>Event Log</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body"><div id="log-popup-content"></div></div>
                <div class="modal-footer">
                    <button type="button" id="clearLogBtn" class="btn btn-warning">Clear Log</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- DOM ELEMENTS & STATE ---
    const welcomeScreen = document.getElementById('welcome-screen');
    const playerScreen = document.getElementById('player-screen');
    const audio = document.getElementById('audioPlayer');
    const playlistEl = document.getElementById('playlist');
    const infoBar = document.getElementById('info-bar');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const songTitleEl = document.getElementById('current-song-title');
    const logPopupContent = document.getElementById('log-popup-content');
    const playIcon = '<i class="bi bi-play-fill"></i>';
    const pauseIcon = '<i class="bi bi-pause-fill"></i>';
    let isHost = false;
    let roomRef;
    let guestConnections = {}; // Stores { guestId: RTCPeerConnection }
    let guestChannels = [];
    const SESSION_STORAGE_KEY = 'musicPartySession';
    const canvas = document.getElementById('audioVisualizer');
    const canvasCtx = canvas.getContext('2d');
    let audioContext, analyser, source, dataArray;
    let visualizerInitialized = false;
    let currentTrackIndex = 0;
    const playlistItems = document.querySelectorAll('#playlist li');

    // --- CONFIGURATION ---
    const firebaseConfig = {"apiKey":"AIzaSyDyq1nxDtx80s4PxyGgO8iRAhfX5f0Hg0M","authDomain":"ngoaa-1581992169924.firebaseapp.com","databaseURL":"https://ngoaa-1581992169924.firebaseio.com","projectId":"ngoaa-1581992169924","storageBucket":"ngoaa-1581992169924.appspot.com","messagingSenderId":"714601884037","appId":"1:714601884037:web:7a53288a98ebbfc5bd3cec","measurementId":"G-0ERBB0KJ9T"};
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const peerConnectionConfig = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'},{'urls': 'stun:stun1.l.google.com:19302'}]};

    // --- SETUP & SESSION MANAGEMENT ---
    window.addEventListener('DOMContentLoaded', () => {
        const sessionRaw = localStorage.getItem(SESSION_STORAGE_KEY);
        if (sessionRaw) {
            const session = JSON.parse(sessionRaw);
            if (session.roomId) {
                isHost = session.isHost;
                isHost ? startHostSession(session.roomId) : startGuestSession(session.roomId);
            }
        }
    });
    function setupHost() {
        isHost = true;
        const roomId = prompt("Enter a unique name for your party room:", `party-${Math.random().toString(36).substr(2, 5)}`);
        if (roomId) {
            localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify({ roomId, isHost: true }));
            startHostSession(roomId);
        }
    }
    function setupGuest() {
        isHost = false;
        const roomId = document.getElementById('roomIdInput').value.trim();
        if (roomId) {
            localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify({ roomId, isHost: false }));
            startGuestSession(roomId);
        } else {
            alert("Please enter a Room ID.");
        }
    }
    document.getElementById('hostBtn').addEventListener('click', setupHost);
    document.getElementById('joinBtn').addEventListener('click', setupGuest);
    document.getElementById('leaveBtn').addEventListener('click', disconnect);
    document.getElementById('clearLogBtn').addEventListener('click', () => {
        logPopupContent.innerHTML = '';
        logToUI('Log cleared by user.', 'info');
    });

    function showScreen(screenName) {
        welcomeScreen.classList.add('d-none');
        playerScreen.classList.add('d-none');
        document.getElementById(`${screenName}-screen`).classList.remove('d-none');
    }

    async function disconnect() {
        logToUI('Leaving party and clearing session...', 'error');
        localStorage.removeItem(SESSION_STORAGE_KEY);
        Object.values(guestConnections).forEach(pc => pc.close());
        guestConnections = {};
        guestChannels = [];
        if (isHost && roomRef) await roomRef.remove();
        if (roomRef) roomRef.off();
        isHost = false;
        audio.pause();
        audio.currentTime = 0;
        showScreen('welcome');
    }

    // --- CORE WEBRTC & FIREBASE LOGIC ---
    async function startHostSession(roomId) {
        showScreen('player');
        infoBar.innerHTML = `Room ID: <strong class="user-select-all">${roomId}</strong> | Guests: <span id="connectionCount">0</span>`;
        roomRef = db.ref('rooms/' + roomId);

        await roomRef.remove();
        logToUI(`Starting host session for room: <strong>${roomId}</strong>`, 'success');
        
        const tempPC = new RTCPeerConnection(peerConnectionConfig);
        const offer = await tempPC.createOffer();
        await tempPC.setLocalDescription(offer);
        const offerDescription = tempPC.localDescription;
        tempPC.close();

        await roomRef.child('offer').set(JSON.stringify(offerDescription));
        logToUI('Waiting for guests to connect...', 'info');
        
        roomRef.child('connections').on('child_added', snapshot => {
            const guestId = snapshot.key;
            const guestData = snapshot.val();
            if (guestData.answer && !guestConnections[guestId]) {
                handleGuestConnection(guestId, guestData.answer, offerDescription);
            }
        });
    }

    async function handleGuestConnection(guestId, answer, offer) {
        logToUI(`New guest [${guestId.substr(0, 5)}] attempting to join...`, 'info');

        const peerConnection = new RTCPeerConnection(peerConnectionConfig);
        guestConnections[guestId] = peerConnection;

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                roomRef.child('connections').child(guestId).child('hostCandidates').push().set(JSON.stringify(event.candidate));
            }
        };

        roomRef.child('connections').child(guestId).child('guestCandidates').on('child_added', snapshot => {
            if (snapshot.exists()) {
                peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(snapshot.val())));
            }
        });

        peerConnection.ondatachannel = (event) => {
            const channel = event.channel;
            guestChannels.push(channel);
            
            channel.onopen = () => {
                logToUI(`Guest [${guestId.substr(0, 5)}] connected successfully!`, 'success');
                updateConnectionCount();
                sendCommandToChannel(channel, { type: 'track', index: currentTrackIndex, time: audio.currentTime });
                if (!audio.paused) sendCommandToChannel(channel, { type: 'play', time: audio.currentTime });
            };
            
            channel.onclose = () => {
                logToUI(`Guest [${guestId.substr(0, 5)}] disconnected.`, 'error');
                guestChannels = guestChannels.filter(c => c !== channel);
                delete guestConnections[guestId];
                updateConnectionCount();
            };
        };
        
        await peerConnection.setLocalDescription(offer);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    }

    async function startGuestSession(roomId) {
        showScreen('player');
        logToUI(`Attempting to join room: <strong>${roomId}</strong>`, 'info');
        roomRef = db.ref('rooms/' + roomId);
        const offerSnapshot = await roomRef.child('offer').once('value');
        if (!offerSnapshot.exists()) {
            alert("Room not found. The host may have left or hasn't started yet.");
            disconnect();
            return;
        }

        infoBar.innerHTML = `<i class="bi bi-earbuds"></i> Connected to Party: <strong>${roomId}</strong>`;
        
        const connectionRef = roomRef.child('connections').push();
        const peerConnection = new RTCPeerConnection(peerConnectionConfig);

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                connectionRef.child('guestCandidates').push().set(JSON.stringify(event.candidate));
            }
        };

        connectionRef.child('hostCandidates').on('child_added', snapshot => {
            if(snapshot.exists()){
                peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(snapshot.val())));
            }
        });

        const dataChannel = peerConnection.createDataChannel('guest-channel');
        dataChannel.onmessage = (event) => handleCommand(JSON.parse(event.data));
        dataChannel.onopen = () => logToUI('Connection to host is live!', 'success');
        dataChannel.onclose = () => {
            alert("Disconnected from host. The party may have ended.");
            disconnect();
        };

        const offer = JSON.parse(offerSnapshot.val());
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        await connectionRef.child('answer').set(JSON.stringify(answer));
        logToUI('Answer sent to host. Exchanging connection details...', 'action');
    }

    // --- PLAYER & SYNC LOGIC ---
    function handleCommand(cmd) {
        switch (cmd.type) {
            case 'play': audio.currentTime = cmd.time; audio.play(); break;
            case 'pause': audio.pause(); break;
            case 'seek': audio.currentTime = cmd.time; break;
            case 'track': playTrack(cmd.index, false, cmd.time); break;
        }
    }
    function sendCommand(cmd) {
        if (isHost && guestChannels.length > 0) {
            const commandStr = JSON.stringify(cmd);
            logToUI(`TX: <pre class="d-inline">${commandStr}</pre>`, 'sync');
            guestChannels.forEach(channel => {
                if (channel.readyState === 'open') channel.send(commandStr);
            });
        }
    }
    function sendCommandToChannel(channel, cmd) {
        if (channel && channel.readyState === 'open') {
            channel.send(JSON.stringify(cmd));
        }
    }
    function playTrack(index, fromHostAction = false, startTime = 0) {
        if(index < 0 || index >= playlistItems.length) return;
        currentTrackIndex = index;
        const trackItem = playlistItems[index];
        playlistItems.forEach(item => item.classList.remove('active'));
        trackItem.classList.add('active');
        songTitleEl.textContent = trackItem.dataset.title;
        audio.src = trackItem.dataset.url;
        audio.currentTime = startTime;
        audio.play().catch(e => console.error("Audio play failed:", e));
        if (isHost && fromHostAction) {
            sendCommand({ type: 'track', index: index, time: 0 });
        }
    }
    playPauseBtn.addEventListener('click', () => {
        if (!isHost) return;
        if (audio.paused) { audio.play(); sendCommand({ type: 'play', time: audio.currentTime }); } 
        else { audio.pause(); sendCommand({ type: 'pause' }); }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
        if (!isHost) return;
        playTrack((currentTrackIndex + 1) % playlistItems.length, true);
    });
    document.getElementById('prevBtn').addEventListener('click', () => {
        if (!isHost) return;
        playTrack((currentTrackIndex - 1 + playlistItems.length) % playlistItems.length, true);
    });
    playlistEl.addEventListener('click', (e) => {
        if (!isHost || !e.target.closest('li')) return;
        const newIndex = Array.from(playlistItems).indexOf(e.target.closest('li'));
        if (newIndex !== -1) playTrack(newIndex, true);
    });
    audio.addEventListener('play', () => {
        playPauseBtn.innerHTML = pauseIcon;
        if (!visualizerInitialized) setupAudioVisualizer();
        drawVisualizer();
    });
    audio.addEventListener('pause', () => playPauseBtn.innerHTML = playIcon);
    audio.addEventListener('seeked', () => {
        if (isHost) sendCommand({ type: 'seek', time: audio.currentTime });
    });

    // --- VISUALIZER & UTILITIES ---
    function setupAudioVisualizer() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            source = audioContext.createMediaElementSource(audio);
            analyser = audioContext.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            visualizerInitialized = true;
        } catch (e) {
            logToUI('Error initializing audio context for visualizer.', 'error');
            console.error(e);
        }
    }
    function drawVisualizer() {
        if (audio.paused || !visualizerInitialized) return;
        requestAnimationFrame(drawVisualizer);
        analyser.getByteFrequencyData(dataArray);
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        canvasCtx.fillStyle = '#212529';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        const bufferLength = analyser.frequencyBinCount;
        const barWidth = (canvas.width / bufferLength) * 2;
        let x = 0;
        const gradient = canvasCtx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#69f0ae');
        gradient.addColorStop(1, '#1DB954');
        for(let i = 0; i < bufferLength; i++) {
            let barHeight = dataArray[i] * (canvas.height / 255);
            canvasCtx.fillStyle = gradient;
            canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }
    function updateConnectionCount() {
        const countEl = document.getElementById('connectionCount');
        if (countEl) countEl.textContent = guestChannels.length;
    }
    function logToUI(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        let icon = '';
        switch (type) {
            case 'success': icon = '<i class="bi bi-check-circle-fill text-success"></i> '; break;
            case 'error': icon = '<i class="bi bi-exclamation-triangle-fill text-danger"></i> '; break;
            case 'action': icon = '<i class="bi bi-arrow-right-short text-primary"></i> '; break;
            case 'sync': icon = '<i class="bi bi-broadcast text-info"></i> '; break;
            case 'info': icon = '<i class="bi bi-info-circle-fill text-secondary"></i> '; break;
        }
        logEntry.innerHTML = `${icon}[${timestamp}] ${message}`;
        logPopupContent.appendChild(logEntry);
        logPopupContent.scrollTop = logPopupContent.scrollHeight;
    }
</script>
</body>
</html>