<!doctype html>

<html lang="en">  
<head>  
  <meta charset="utf-8" />  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <title>Music Party</title>    <!-- Bootstrap 5 -->    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>    <!-- QR Code & Scanner -->    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>  </head>  
<body class="bg-light">  <!-- 1. FAB -->  <button id="musicFab" class="btn btn-primary rounded-circle position-fixed shadow-lg"  
style="bottom:20px;right:20px;width:65px;height:65px;font-size:28px;">
ðŸŽµ
</button>

<!-- 2. MODAL -->  <div class="modal fade" id="musicModal" tabindex="-1" aria-hidden="true">  
  <div class="modal-dialog modal-dialog-centered modal-lg">  
    <div class="modal-content rounded-4 shadow-lg">  
      <div class="modal-header border-0">  
        <h5 class="modal-title fw-bold">ðŸŽ¶ Music Party</h5>  
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
      </div>  <div class="modal-body">  
    <!-- CHOICE -->  
    <div id="choiceMenu" class="text-center">  
      <h6 class="mb-4">Start or Join a Party</h6>  
      <div class="d-flex justify-content-center gap-4">  
        <div class="card shadow-sm border-0 rounded-circle p-4" style="width:120px;height:120px;cursor:pointer;" id="chooseHost">  
          <div class="h2">ðŸ‘‘</div>  
          <div class="fw-semibold small mt-2">Host</div>  
        </div>  
        <div class="card shadow-sm border-0 rounded-circle p-4" style="width:120px;height:120px;cursor:pointer;" id="chooseJoin">  
          <div class="h2">ðŸ”—</div>  
          <div class="fw-semibold small mt-2">Join</div>  
        </div>  
      </div>  
    </div>  

    <!-- HOST -->  
    <div id="hostMenu" class="d-none">  
      <h6 class="fw-bold">You're the Host</h6>  
      <div id="partyIdBox" class="fw-bold fs-5 mb-2"></div>  
      <canvas id="qrcode"></canvas>  
      <audio id="audioPlayer" controls class="w-100 mt-3"></audio>  
      <select id="trackSelect" class="form-select mt-3">  
        <option value="Tere jaisa.mp3">Tere Jaisa</option>  
        <option value="Track2.mp3">Track 2</option>  
      </select>  
    </div>  

    <!-- JOIN -->  
    <div id="joinMenu" class="d-none">  
      <h6 class="fw-bold">Join a Party</h6>  
      <div id="reader" style="width:100%;max-width:300px;margin:auto;"></div>  
      <div class="input-group mt-3">  
        <input type="text" id="joinIdInput" class="form-control" placeholder="Enter Party ID">  
        <button class="btn btn-primary" id="joinNowBtn">Join</button>  
      </div>  
      <audio id="guestPlayer" controls class="w-100 mt-3"></audio>  
    </div>  

    <!-- LOGS -->  
    <div id="logs" class="mt-4 p-2 bg-light rounded small" style="height:100px;overflow:auto;font-family:monospace;"></div>  
  </div>  
</div>

  </div>  
</div>  <!-- 3. LIBS -->  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>  <script>  
/* === FIREBASE CONFIG === */  
const firebaseConfig = {
  apiKey: "AIzaSyDyq1nxDtx80s4PxyGgO8iRAhfX5f0Hg0M",
  authDomain: "ngoaa-1581992169924.firebaseapp.com",
  databaseURL: "https://ngoaa-1581992169924.firebaseio.com",
  projectId: "ngoaa-1581992169924",
  storageBucket: "ngoaa-1581992169924.appspot.com",
  messagingSenderId: "714601884037",
  appId: "1:714601884037:web:7a53288a98ebbfc5bd3cec",
  measurementId: "G-0ERBB0KJ9T"
};

firebase.initializeApp(firebaseConfig);  
const db = firebase.database();  
  
/* === ELEMENTS === */  
const logs = document.getElementById('logs');  
const hostMenu = document.getElementById('hostMenu');  
const joinMenu = document.getElementById('joinMenu');  
const audio = document.getElementById('audioPlayer');  
const guestAudio = document.getElementById('guestPlayer');  
const trackSelect = document.getElementById('trackSelect');  
  
let myId = Math.random().toString(36).substr(2,6);  
let partyId = null;  
let pc, dc, isHost=false;  
  
/* === HELPERS === */  
function log(msg){  
  logs.innerHTML += msg+"<br>";  
  logs.scrollTop = logs.scrollHeight;  
}  
function createPeer(){  
  pc = new RTCPeerConnection();  
  dc = pc.createDataChannel("music");  
  dc.onmessage = e => handleMessage(e.data);  
  pc.onicecandidate = e=>{  
    if(e.candidate){  
      db.ref("parties/"+partyId+"/candidates").push(JSON.stringify(e.candidate));  
    }  
  };  
}  
  
/* === HOST === */  
document.getElementById('chooseHost').onclick = async ()=>{  
  document.getElementById("choiceMenu").classList.add("d-none");  
  hostMenu.classList.remove("d-none");  
  isHost = true;  
  partyId = myId;  
  document.getElementById("partyIdBox").innerText = "Party ID: "+partyId;  
  QRCode.toCanvas(document.getElementById("qrcode"), partyId, { width:150 });  
  log("Hosting party: "+partyId);  
  
  createPeer();  
  const offer = await pc.createOffer();  
  await pc.setLocalDescription(offer);  
  db.ref("parties/"+partyId+"/offer").set(JSON.stringify(offer));  
  
  db.ref("parties/"+partyId+"/answer").on("value", async snap=>{  
    if(snap.val()){  
      let ans = JSON.parse(snap.val());  
      await pc.setRemoteDescription(new RTCSessionDescription(ans));  
      log("Guest joined.");  
    }  
  });  
  db.ref("parties/"+partyId+"/candidates").on("child_added", async s=>{  
    let cand = JSON.parse(s.val());  
    try{ await pc.addIceCandidate(new RTCIceCandidate(cand)); }catch{}  
  });  
  
  // Track select sync  
  trackSelect.onchange = ()=>{  
    send({type:"track", value:trackSelect.value});  
    audio.src = trackSelect.value;  
    audio.play();  
  };  
  audio.ontimeupdate = ()=>{  
    send({type:"time", value:audio.currentTime});  
  };  
};  
  
/* === JOIN === */  
document.getElementById('chooseJoin').onclick = ()=>{  
  document.getElementById("choiceMenu").classList.add("d-none");  
  joinMenu.classList.remove("d-none");  
  const qr = new Html5Qrcode("reader");  
  qr.start({facingMode:"environment"}, {fps:10,qrbox:200}, code=>{  
    document.getElementById("joinIdInput").value=code;  
    qr.stop();  
  });  
};  
document.getElementById("joinNowBtn").onclick = async ()=>{  
  partyId = document.getElementById("joinIdInput").value.trim();  
  if(!partyId){alert("Enter Party ID");return;}  
  log("Joining "+partyId);  
  
  pc = new RTCPeerConnection();  
  pc.ondatachannel = e=>{  
    dc = e.channel;  
    dc.onmessage = ev=>handleMessage(ev.data);  
  };  
  pc.onicecandidate = e=>{  
    if(e.candidate){  
      db.ref("parties/"+partyId+"/candidates").push(JSON.stringify(e.candidate));  
    }  
  };  
  
  let offerSnap = await db.ref("parties/"+partyId+"/offer").get();  
  if(!offerSnap.exists()){ log("No host found"); return; }  
  let offer = JSON.parse(offerSnap.val());  
  await pc.setRemoteDescription(new RTCSessionDescription(offer));  
  let answer = await pc.createAnswer();  
  await pc.setLocalDescription(answer);  
  db.ref("parties/"+partyId+"/answer").set(JSON.stringify(answer));  
  
  db.ref("parties/"+partyId+"/candidates").on("child_added", async s=>{  
    let cand = JSON.parse(s.val());  
    try{ await pc.addIceCandidate(new RTCIceCandidate(cand)); }catch{}  
  });  
};  
  
/* === MESSAGING === */  
function send(obj){ if(dc && dc.readyState==="open"){ dc.send(JSON.stringify(obj)); } }  
function handleMessage(msg){  
  let data = JSON.parse(msg);  
  if(data.type==="track"){  
    log("Host selected track: "+data.value);  
    guestAudio.src = data.value;  
    guestAudio.play();  
  }  
  if(data.type==="time"){  
    if(Math.abs(guestAudio.currentTime-data.value)>0.5){  
      guestAudio.currentTime = data.value;  
    }  
  }  
}  
  
/* === OPEN MODAL === */  
document.getElementById('musicFab').onclick=()=>{  
  new bootstrap.Modal(document.getElementById('musicModal')).show();  
};  
</script>  </body>  
</html>  
